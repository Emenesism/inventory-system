from __future__ import annotations

from typing import NamedTuple

from PySide6.QtCore import QCoreApplication


class HelpContent(NamedTuple):
    title: str
    body: str


def _t(text: str) -> str:
    return QCoreApplication.translate("HelpContent", text)


def _wrap(body: str) -> str:
    return (
        '<div dir="rtl" style="font-size: 13px; line-height: 1.9; '
        'text-align: right; unicode-bidi: plaintext;">'
        + body.strip()
        + "</div>"
    )


HELP_CONTENT: dict[str, HelpContent] = {
    "Inventory": HelpContent(
        title=_t("راهنمای بخش موجودی"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>این صفحه مرکز مدیریت موجودی است. می‌توانید کالاها را جستجو، ویرایش، اضافه، حذف و از وضعیت فعلی خروجی بگیرید.</p>

                <h3>کنترل‌ها و دکمه‌ها</h3>
                <ul>
                    <li><b>جستجوی کالا...</b> فیلتر سریع جدول بر اساس نام یا اطلاعات کالا.</li>
                    <li><b>بارگذاری مجدد:</b> بازخوانی داده‌ها و حذف تغییرات ذخیره‌نشده.</li>
                    <li><b>ذخیره تغییرات:</b> ارسال همه ویرایش‌ها به بک‌اند موجودی.</li>
                    <li><b>افزودن ردیف:</b> ساخت یک ردیف کالای جدید در جدول.</li>
                    <li><b>حذف انتخاب‌شده:</b> حذف ردیف‌های انتخابی.</li>
                    <li><b>خروجی:</b> ذخیره خروجی اکسل یا CSV از اطلاعات فعلی.</li>
                </ul>

                <h3>روند پیشنهادی</h3>
                <ol>
                    <li>کالا را در جدول پیدا کنید یا با جستجو فیلتر کنید.</li>
                    <li>مقادیر را ویرایش کنید یا ردیف جدید اضافه کنید.</li>
                    <li>در پایان روی «ذخیره تغییرات» بزنید تا تغییرات ثبت شوند.</li>
                    <li>در صورت نیاز، با «خروجی» نسخه فایل تهیه کنید.</li>
                </ol>

                <h3>نکته مهم</h3>
                <p>در رابط کاربری جدید، دکمه «انتخاب فایل موجودی» از هدر حذف شده است و موجودی از بک‌اند بارگذاری می‌شود.</p>
                """
            )
        ),
    ),
    "Sales Import": HelpContent(
        title=_t("راهنمای بخش ثبت فاکتور فروش"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>این صفحه فایل فروش را می‌خواند، پیش‌نمایش تطبیق می‌سازد و در صورت تایید، فروش را روی موجودی اعمال می‌کند.</p>

                <h3>دکمه‌های اصلی</h3>
                <ul>
                    <li><b>مرور:</b> انتخاب فایل فروش (Excel/CSV).</li>
                    <li><b>بارگذاری پیش‌نمایش:</b> خواندن فایل و نمایش نتیجه تطبیق هر ردیف.</li>
                    <li><b>فاکتور دستی:</b> ثبت فروش بدون فایل ورودی.</li>
                    <li><b>اعمال تغییرات:</b> ثبت فروش‌های معتبر و به‌روزرسانی موجودی.</li>
                    <li><b>خروجی:</b> خروجی گرفتن از نتایج پیش‌نمایش.</li>
                </ul>

                <h3>روند پیشنهادی</h3>
                <ol>
                    <li>فایل فروش را با «مرور» انتخاب کنید.</li>
                    <li>روی «بارگذاری پیش‌نمایش» بزنید و منبع فروش را انتخاب کنید.</li>
                    <li>ردیف‌های خطادار را در جدول اصلاح کنید (نام کالا/تعداد).</li>
                    <li>وقتی خطاها رفع شد، «اعمال تغییرات» را اجرا کنید.</li>
                </ol>

                <h3>نکته</h3>
                <p>ستون‌های مورد انتظار فایل: نام کالا و تعداد (یا تعداد فروش). وجود قیمت فروش اختیاری است.</p>
                """
            )
        ),
    ),
    "Purchase Invoice": HelpContent(
        title=_t("راهنمای بخش ثبت فاکتور خرید"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>برای ثبت خرید جدید و افزایش موجودی کالاها استفاده می‌شود.</p>

                <h3>دکمه‌های اصلی</h3>
                <ul>
                    <li><b>افزودن ردیف:</b> افزودن کالای جدید به فاکتور.</li>
                    <li><b>حذف انتخاب‌شده:</b> حذف ردیف‌های انتخاب‌شده.</li>
                    <li><b>ثبت فاکتور:</b> ثبت نهایی خرید و اعمال روی موجودی.</li>
                </ul>

                <h3>نحوه تکمیل فاکتور</h3>
                <ol>
                    <li>نام کالا را وارد کنید (پیشنهادهای مشابه نمایش داده می‌شود).</li>
                    <li>تعداد و قیمت خرید را تکمیل کنید.</li>
                    <li>برای اقلام بعدی ردیف اضافه کنید.</li>
                    <li>در پایان روی «ثبت فاکتور» بزنید.</li>
                </ol>

                <h3>نکته</h3>
                <p>کلید Enter بین ردیف‌ها حرکت می‌کند و Delete می‌تواند ردیف انتخابی را حذف کند.</p>
                """
            )
        ),
    ),
    "Invoices": HelpContent(
        title=_t("راهنمای بخش فاکتورها"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>آرشیو کامل فاکتورهای خرید و فروش در این بخش نمایش داده می‌شود و می‌توانید جزئیات هر فاکتور را بررسی یا خروجی بگیرید.</p>

                <h3>دکمه‌های اصلی</h3>
                <ul>
                    <li><b>خروجی فاکتور:</b> خروجی گروهی از فاکتورها با فیلترهای زمانی/محصول.</li>
                    <li><b>بروزرسانی:</b> بازخوانی لیست فاکتورها.</li>
                    <li><b>ویرایش فاکتور:</b> ویرایش فاکتور منتخب (فقط با دسترسی مناسب).</li>
                    <li><b>حذف فاکتور:</b> حذف فاکتور منتخب (فقط با دسترسی مناسب).</li>
                    <li><b>موارد بیشتر:</b> بارگذاری مرحله‌ای لیست‌های طولانی.</li>
                </ul>

                <h3>قابلیت‌های جدول</h3>
                <ul>
                    <li>با انتخاب هر ردیف، جزئیات کامل فاکتور در کارت پایین نمایش داده می‌شود.</li>
                    <li>در ستون «خروجی» هر ردیف می‌توانید همان فاکتور را مستقیم به PDF یا Excel بگیرید.</li>
                    <li>نمایش مبلغ برای برخی نقش‌ها یا نوع فاکتور ممکن است محدود شود.</li>
                </ul>

                <h3>نکته</h3>
                <p>بعد از هر ویرایش/حذف، یک بار «بروزرسانی» بزنید تا لیست و جمع مبالغ همگام شوند.</p>
                """
            )
        ),
    ),
    "Analytics": HelpContent(
        title=_t("راهنمای بخش تحلیل"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>این صفحه خلاصه عملکرد مالی را از روی فاکتورها نمایش می‌دهد.</p>

                <h3>دکمه اصلی</h3>
                <ul>
                    <li><b>بروزرسانی:</b> محاسبه مجدد آمار و لیست‌ها با آخرین داده‌ها.</li>
                </ul>

                <h3>موارد قابل مشاهده</h3>
                <ul>
                    <li>آمار کلی فروش، خرید، خالص موجودی و تعداد فاکتور فروش.</li>
                    <li>لیست کالاهای پرفروش با فیلتر بازه زمانی و تعداد آیتم‌ها.</li>
                    <li>لیست کالاهای بدون فروش با فیلتر بازه زمانی.</li>
                </ul>
                """
            )
        ),
    ),
    "Low Stock": HelpContent(
        title=_t("راهنمای بخش کمبود موجودی"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>کالاهای زیر حد هشدار را نمایش می‌دهد تا برای تامین مجدد سریع‌تر تصمیم بگیرید.</p>

                <h3>دکمه‌های اصلی</h3>
                <ul>
                    <li><b>بروزرسانی:</b> محاسبه دوباره کمبودها بر اساس موجودی فعلی.</li>
                    <li><b>خروجی:</b> ذخیره لیست کمبود در Excel یا CSV.</li>
                </ul>

                <h3>موارد اصلی</h3>
                <ul>
                    <li>ستون‌های کالا، تعداد، هشدار، نیاز، میانگین خرید و منبع.</li>
                    <li>جمع تعداد کالاهای کمبوددار و مجموع نیاز.</li>
                    <li>رنگ‌بندی شدت کمبود برای تشخیص سریع موارد بحرانی.</li>
                </ul>
                """
            )
        ),
    ),
    "Basalam": HelpContent(
        title=_t("راهنمای بخش باسلام"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>برای دریافت سفارش‌های باسلام در بازه زمانی مشخص، بررسی نتیجه و گرفتن خروجی استفاده می‌شود.</p>

                <h3>روند کار</h3>
                <ul>
                    <li>«شروع پرداخت (جلالی)» و «پایان پرداخت (جلالی)» را تنظیم کنید.</li>
                    <li>روی «دریافت» بزنید و وضعیت نوار پیشرفت را دنبال کنید.</li>
                    <li>بعد از پایان دریافت، جدول را بررسی کنید و در صورت نیاز «خروجی» بگیرید.</li>
                </ul>

                <h3>نکته</h3>
                <p>برای دریافت موفق، مقدار <code>access_token</code> باید در پیکربندی برنامه ثبت شده باشد.</p>
                """
            )
        ),
    ),
    "Actions": HelpContent(
        title=_t("راهنمای بخش اقدامات"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>تمام عملیات ثبت‌شده کاربران و سیستم در این صفحه قابل پیگیری است.</p>

                <h3>قابلیت‌ها</h3>
                <ul>
                    <li><b>جستجو در اقدامات...</b> فیلتر سریع بر اساس عنوان/جزئیات.</li>
                    <li><b>بروزرسانی:</b> بازخوانی لاگ اقدامات.</li>
                    <li><b>موارد بیشتر:</b> بارگذاری مرحله‌ای در لیست‌های طولانی.</li>
                    <li>نمایش جزئیات کامل اقدام انتخابی در کارت پایین.</li>
                </ul>

                <h3>نکته دسترسی</h3>
                <p>این صفحه برای نقش‌های محدود، غیرفعال و محو نمایش داده می‌شود.</p>
                """
            )
        ),
    ),
    "Reports/Logs": HelpContent(
        title=_t("راهنمای بخش گزارش‌ها و لاگ‌ها"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>نمایش لاگ‌های برنامه برای بررسی خطاها و عملیات انجام‌شده.</p>

                <h3>دکمه‌های اصلی</h3>
                <ul>
                    <li><b>بارگذاری کامل:</b> نمایش کل تاریخچه لاگ.</li>
                    <li><b>نمایش 1000 خط آخر:</b> مشاهده سریع آخرین رخدادها.</li>
                    <li><b>خروجی 1000 خط آخر:</b> ذخیره گزارش در فایل متنی.</li>
                </ul>

                <h3>نکته</h3>
                <p>در نبود لاگ، پیام «فایل لاگ هنوز ایجاد نشده است» نمایش داده می‌شود.</p>
                """
            )
        ),
    ),
    "Settings": HelpContent(
        title=_t("راهنمای بخش تنظیمات"),
        body=_wrap(
            _t(
                """
                <h3>کاربرد این بخش</h3>
                <p>تنظیمات ظاهری برنامه، مدیریت حساب‌ها و امنیت در این صفحه انجام می‌شود.</p>

                <h3>موارد اصلی</h3>
                <ul>
                    <li><b>پوسته:</b> تغییر بین حالت روشن و تیره.</li>
                    <li><b>حساب کاربری:</b> نمایش کاربر فعلی و تغییر رمز عبور.</li>
                    <li><b>مدیریت مدیران:</b> ایجاد و حذف مدیر/کارمند (فقط برای مدیر).</li>
                </ul>

                <h3>نکته امنیتی</h3>
                <p>برای تغییر رمز، وارد کردن «رمز عبور فعلی» الزامی است.</p>
                """
            )
        ),
    ),
}


def get_help_content(page_name: str) -> HelpContent:
    content = HELP_CONTENT.get(page_name)
    if content:
        return content
    return HelpContent(
        title=_t("راهنمای این بخش"),
        body=_wrap(
            _t(
                """
                <p>برای این بخش هنوز راهنمای اختصاصی آماده نشده است.</p>
                """
            )
        ),
    )
